name: factorio-headless
summary: Headless server for Factorio running as a system service
description: |
  Change configuration options

    sudo snap get factorio-headless
    sudo snap set factorio-headless admins='["kovarex"]'
    sudo snap set factorio-headless game-password=1337
    sudo snap restart factorio-headless

  Control the service and check status

    sudo snap start factorio-headless
    sudo snap stop factorio-headless
    sudo snap start --enable factorio-headless
    sudo snap stop --disable factorio-headless
    sudo snap services | grep factorio-headless

  Server files location

    ls /var/snap/factorio-headless/common

adopt-info: factorio
base: core18
grade: stable
confinement: strict
architectures:
  - build-on: amd64

system-usernames:
  snap_daemon: shared

apps:
  factorio-headless:
    command: wrapper factorio-headless
    completer: completion
    plugs: &plugs
      - home
      - network
      - network-bind
  
  mods:
    command: wrapper mods
    completer: completion
    plugs: *plugs

  service:
    command: wrapper service
    daemon: simple
    stop-timeout: 1m
    plugs: *plugs

parts:
  factorio:
    source: https://www.factorio.com/get-download/latest/headless/linux64
    source-type: tar
    plugin: dump
    override-build: |
      snapcraftctl build
      snapcraftctl set-version `cat data/base/info.json | jq -r .version`
    build-packages:
      - jq
    organize:
      '*': factorio/

  config:
    source: config/
    plugin: dump
    organize:
      '*': factorio/

  scripts:
    source: scripts/
    plugin: dump
    stage-packages:
      - setpriv
      - curl
      - jq
